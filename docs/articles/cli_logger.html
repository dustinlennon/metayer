<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>metayer: folding cli into logger • metayer</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="metayer: folding cli into logger">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metayer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/authoring.html">metayer: authoring tools</a></li>
    <li><a class="dropdown-item" href="../articles/cli_logger.html">metayer: folding cli into logger</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>metayer: folding cli into logger</h1>
            
      

      <div class="d-none name"><code>cli_logger.Rmd</code></div>
    </div>

    
    
<p>As prototypes evolve into robust software, one common challenge is to
smoothly phase out less scalable development patterns. In the world of
the tidyverse, scripts often leverage the <code>cli</code> package for
logging purposes. As things evolve and these scripts are refactored, it
may be useful to fold <code>cli</code> output into a more structured
logging environment. <code>metayer</code> makes this transition
relatively painless, and this vignette walks through the process.</p>
<div class="section level3">
<h3 id="load-the-metayer-package">load the metayer package<a class="anchor" aria-label="anchor" href="#load-the-metayer-package"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://daroczig.github.io/logger/" class="external-link">logger</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">metayer</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="logger-basics">logger basics<a class="anchor" aria-label="anchor" href="#logger-basics"></a>
</h2>
<p>The logger package documentation is at <a href="https://daroczig.github.io/logger" class="external-link">https://daroczig.github.io/logger</a>.</p>
<p>Logs are organized by namespace, the idea being that some base
configuration is adapted across new namespaces. This makes it relatively
easy to manage multiple streams of logs. To start, the pattern is
typically:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_threshold.html" class="external-link">log_threshold</a></span><span class="op">(</span><span class="va">INFO</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_appender.html" class="external-link">log_appender</a></span><span class="op">(</span><span class="va">appender_stdout</span><span class="op">)</span> <span class="co"># in jupyter, for example</span></span>
<span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_level.html" class="external-link">log_info</a></span><span class="op">(</span><span class="st">"hello world"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## INFO [2024-08-07 12:45:30] hello world</span></span></code></pre>
<p>If we want to change the layout, say, to show the namespace:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_layout.html" class="external-link">log_layout</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://daroczig.github.io/logger/reference/layout_glue_generator.html" class="external-link">layout_glue_generator</a></span><span class="op">(</span></span>
<span>    format <span class="op">=</span> <span class="st">"{ns} {level} [{format(time, \"%Y-%m-%d %H:%M:%S\")}] {msg}"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_level.html" class="external-link">log_info</a></span><span class="op">(</span><span class="st">"a new format, with namespaces"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## global INFO [2024-08-07 12:45:30] a new format, with namespaces</span></span></code></pre>
<p>Or, perhaps we want send logs to a file. This can be accomplished
with a new, “logfile”, namespace.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_appender.html" class="external-link">log_appender</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://daroczig.github.io/logger/reference/appender_file.html" class="external-link">appender_file</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span>,</span>
<span>    namespace <span class="op">=</span> <span class="st">"logfile"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_level.html" class="external-link">log_info</a></span><span class="op">(</span><span class="st">"to the filesystem"</span>, namespace <span class="op">=</span> <span class="st">"logfile"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read from the temporary file</span></span>
<span><span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu">xfun</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xfun/man/read_utf8.html" class="external-link">read_utf8</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">msg</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## logfile INFO [2024-08-07 12:45:30] to the filesystem</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="cli">cli<a class="anchor" aria-label="anchor" href="#cli"></a>
</h2>
<p>For scripts that already leverage the <code>cli</code> package,
<code>metayer</code> provides some easy shims to redirect cli messages
into logger. These shims use the <code>cli.default_handler</code>
hook:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>cli.default_handler <span class="op">=</span> <span class="va">logged_cli_handler</span><span class="op">)</span></span></code></pre></div>
<p>As before,</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/logger_reset.html">logger_reset</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_level.html" class="external-link">log_info</a></span><span class="op">(</span><span class="st">"hello world"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## global INFO [2024-08-07 12:45:30] hello world</span></span></code></pre>
<p>However, calling <code>cli_text</code>, a wrapped version of
<code><a href="https://cli.r-lib.org/reference/cli_text.html" class="external-link">cli::cli_text</a></code> produces output on two new namespaces:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cli_text.html">cli_text</a></span><span class="op">(</span><span class="st">"a cli output"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## metayer INFO [2024-08-07 12:45:30] adding logger namespace: global.cli</span></span>
<span><span class="co">## global.cli INFO [2024-08-07 12:45:30] a cli output</span></span></code></pre>
<p>The first is from a function in the <code>metayer</code> package
namespace; in fact, the <code>logged_cli_handler</code> function. The
second is to a namespace called <code>global.cli</code> which indicates
that a cli function was called in the global environment. Or at least
that’s what you’ll see if you were in an interpreter. However, in an
authoring context, you may see <code>metayer.cli</code> instead. This
would be because the vignette was, in that context, using the package
namespace.</p>
<div class="section level3">
<h3 id="lower-level-logging">lower level logging<a class="anchor" aria-label="anchor" href="#lower-level-logging"></a>
</h3>
<p>Suppose we wanted to examine lower level logging but only in the
<code>metayer</code> package. The following will suffice:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_threshold.html" class="external-link">log_threshold</a></span><span class="op">(</span><span class="va">TRACE</span>, namespace <span class="op">=</span> <span class="st">"metayer"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/cli_text.html">cli_text</a></span><span class="op">(</span><span class="st">"a cli output"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## metayer TRACE [2024-08-07 12:45:30] e988 logged_cli_handler begin</span></span>
<span><span class="co">## metayer TRACE [2024-08-07 12:45:30] e988 level = 400; namespace = global.cli; type = text</span></span>
<span><span class="co">## metayer TRACE [2024-08-07 12:45:30] e988 handler generated output</span></span>
<span><span class="co">## global.cli INFO [2024-08-07 12:45:30] a cli output</span></span>
<span><span class="co">## metayer TRACE [2024-08-07 12:45:30] e988 logged_cli_handler end</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># restore the previous threshold</span></span>
<span><span class="fu"><a href="https://daroczig.github.io/logger/reference/log_threshold.html" class="external-link">log_threshold</a></span><span class="op">(</span><span class="va">INFO</span>, namespace <span class="op">=</span> <span class="st">"metayer"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="appendix-wrapping-via-metaprogramming">appendix: wrapping via metaprogramming<a class="anchor" aria-label="anchor" href="#appendix-wrapping-via-metaprogramming"></a>
</h2>
<p>Each <code>cli</code> function is wrapped with logic that captures
conditions and sends the corresponding condition messages into the
<code>logger</code> machinery. This all happens in the
<code>cli-wrapped.R</code> source file, and there are scripts that
automate this process. In particular, these scripts generate entries
like the following:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cli_alert</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cli_wrap_safe.html">cli_wrap_safe</a></span><span class="op">(</span><span class="st">"cli_alert"</span>, <span class="fu">logger</span><span class="fu">::</span><span class="va"><a href="https://daroczig.github.io/logger/reference/log_levels.html" class="external-link">INFO</a></span><span class="op">)</span></span></code></pre></div>
<p>where <code>cli_wrap_safe</code> manages the details. The wrapping
logic lives in the <code>wrap_cli_body</code> function. This is
interesting because it’s called both directly and via a metaprogramming
substitution.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">code</span> <span class="op">&lt;-</span> <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">wrap_cli_body</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"&lt;environment: .*&gt;"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/display_source.html">display_source</a></span><span class="op">(</span></span>
<span>    <span class="va">code</span>,</span>
<span>    raw <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:2:0: unexpected end of input</span></span>
<span><span class="co">## 1: function (cmd_call, level, .caller_env = caller_env()) </span></span>
<span><span class="co">##    ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:2:0: unexpected end of input</span></span>
<span><span class="co">## 1: {</span></span>
<span><span class="co">##    ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:2:0: unexpected end of input</span></span>
<span><span class="co">## 1:     outer_cnd &lt;- catch_cnd({</span></span>
<span><span class="co">##    ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:2:0: unexpected end of input</span></span>
<span><span class="co">## 1:         if ("cmd_call" %in% names(mc)) {</span></span>
<span><span class="co">##    ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:9: unexpected '}'</span></span>
<span><span class="co">## 1:         }</span></span>
<span><span class="co">##             ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:9: unexpected 'else'</span></span>
<span><span class="co">## 1:         else</span></span>
<span><span class="co">##             ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:9: unexpected '}'</span></span>
<span><span class="co">## 1:         }</span></span>
<span><span class="co">##             ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:5: unexpected '}'</span></span>
<span><span class="co">## 1:     }</span></span>
<span><span class="co">##         ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:2:0: unexpected end of input</span></span>
<span><span class="co">## 1:     if (inherits(outer_cnd, "cli_message")) {</span></span>
<span><span class="co">##    ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:5: unexpected '}'</span></span>
<span><span class="co">## 1:     }</span></span>
<span><span class="co">##         ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:5: unexpected 'else'</span></span>
<span><span class="co">## 1:     else</span></span>
<span><span class="co">##         ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:2:0: unexpected end of input</span></span>
<span><span class="co">## 1:         cnd &lt;- catch_cnd(cli::cli_verbatim(format(outer_cnd, </span></span>
<span><span class="co">##    ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:30: unexpected ')'</span></span>
<span><span class="co">## 1:             backtrace = FALSE)</span></span>
<span><span class="co">##                                  ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:5: unexpected '}'</span></span>
<span><span class="co">## 1:     }</span></span>
<span><span class="co">##         ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:5: unexpected 'else'</span></span>
<span><span class="co">## 1:     else</span></span>
<span><span class="co">##         ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:5: unexpected '}'</span></span>
<span><span class="co">## 1:     }</span></span>
<span><span class="co">##         ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:1: unexpected '}'</span></span>
<span><span class="co">## 1: }</span></span>
<span><span class="co">##     ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<pre><code><span><span class="co">## Error in parse(text = code, keep.source = FALSE) : </span></span>
<span><span class="co">##   &lt;text&gt;:1:1: unexpected '&lt;'</span></span>
<span><span class="co">## 1: &lt;</span></span>
<span><span class="co">##     ^</span></span></code></pre>
<pre><code><span><span class="co">## Warning in hilight(code, "html", ...): the syntax of the source code is</span></span>
<span><span class="co">## invalid; the fallback mode is used</span></span></code></pre>
<!-- rnb-html-begin -->
<div id="div-f964">
<style>
#div-f964 .inline, #div-f964 .source {
  background-color: #fff5ee;
}
#div-f964 .source {
  margin: 1em 0 0 0;
  padding: 1em;
}
#div-f964 .hl.num {
  color: #ff1493;
}
#div-f964 .hl.sng {
  color: #ff1493;
}
#div-f964 .hl.com {
  color: #2929cc;
}
#div-f964 .hl.opt {
  color: #676767;
}
#div-f964 .hl.def {
  color: #000000;
}
#div-f964 .hl.kwa {
  color: #2e8b57;
  font-weight: bold;
}
#div-f964 .hl.kwb {
  color: #2e8b57;
  font-weight: bold;
}
#div-f964 .hl.kwc {
  color: #696969;
  font-weight: bold;
}
#div-f964 .hl.kwd {
  color: #00008f;
}
</style>
<pre><div class="source">
<span class="hl kwd"><span class="hl kwa">function</span></span> (cmd_call, level, .caller_env = <span class="hl kwd">caller_env</span>()) </div></pre>
<pre><div class="source">{</div></pre>
<pre><div class="source">    <span class="hl def">mc</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">match.call</span><span class="hl def">()</span>
</div></pre>
<pre><div class="source">    <span class="hl def">.current_env</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">current_env</span><span class="hl def">()</span>
</div></pre>
<pre><div class="source">    <span class="hl def">.caller_env</span> <span class="hl kwb">&lt;-</span> <span class="hl def">.current_env</span><span class="hl opt">$</span><span class="hl def">.caller_env</span> <span class="hl opt">%||%</span> <span class="hl kwd">caller_env</span><span class="hl def">()</span>
</div></pre>
<pre><div class="source">    outer_cnd &lt;- <span class="hl kwd">catch_cnd</span>({</div></pre>
<pre><div class="source">        <span class="hl kwd"><span class="hl kwa">if</span></span> (<span class="hl sng">"cmd_call"</span> %<span class="hl kwa">in</span>% <span class="hl kwd">names</span>(mc)) {</div></pre>
<pre><div class="source">            <span class="hl kwd">eval</span><span class="hl def">(.current_env</span><span class="hl opt">$</span><span class="hl def">cmd_call,</span> <span class="hl kwc">envir</span> <span class="hl def">= .current_env)</span>
</div></pre>
<pre><div class="source">        }</div></pre>
<pre><div class="source">        <span class="hl kwa">else</span> {</div></pre>
<pre><div class="source">            <span class="hl def">cmd_call</span>
</div></pre>
<pre><div class="source">        }</div></pre>
<pre><div class="source">    })</div></pre>
<pre><div class="source">    <span class="hl kwd"><span class="hl kwa">if</span></span> (<span class="hl kwd">inherits</span>(outer_cnd, <span class="hl sng">"cli_message"</span>)) {</div></pre>
<pre><div class="source">        <span class="hl def">cnd</span> <span class="hl kwb">&lt;-</span> <span class="hl def">outer_cnd</span>
</div></pre>
<pre><div class="source">    }</div></pre>
<pre><div class="source">    <span class="hl kwa">else</span> <span class="hl kwd"><span class="hl kwa">if</span></span> (<span class="hl kwd">inherits</span>(outer_cnd, <span class="hl sng">"condition"</span>)) {</div></pre>
<pre><div class="source">        cnd &lt;- <span class="hl kwd">catch_cnd</span>(cli::<span class="hl kwd">cli_verbatim</span>(<span class="hl kwd">format</span>(outer_cnd, </div></pre>
<pre><div class="source">            backtrace = <span class="hl kwa">FALSE</span>)))</div></pre>
<pre><div class="source">    }</div></pre>
<pre><div class="source">    <span class="hl kwa">else</span> {</div></pre>
<pre><div class="source">        <span class="hl def">msg</span> <span class="hl kwb">&lt;-</span> <span class="hl def">glue</span><span class="hl opt">::</span><span class="hl kwd">glue</span><span class="hl def">(</span><span class="hl sng">"unexpected result: {outer_cnd}"</span><span class="hl def">,</span> <span class="hl kwc">.null</span> <span class="hl def">=</span> <span class="hl kwd">getOption</span><span class="hl def">(</span><span class="hl sng">"metayer.cli_null"</span><span class="hl def">))</span>
</div></pre>
<pre><div class="source">        <span class="hl def">cnd</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">error_cnd</span><span class="hl def">(</span><span class="hl kwc">message</span> <span class="hl def">= msg)</span>
</div></pre>
<pre><div class="source">    }</div></pre>
<pre><div class="source">    <span class="hl def">wenv</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">new_environment</span><span class="hl def">(</span><span class="hl kwc">parent</span> <span class="hl def">= .current_env)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">env_rename</span><span class="hl def">(</span><span class="hl sng">"logger_injection"</span><span class="hl def">)</span>
</div></pre>
<pre><div class="source">    <span class="hl kwd">env_bind</span><span class="hl def">(wenv,</span> <span class="hl kwc">.log_level</span> <span class="hl def">= level,</span> <span class="hl kwc">.log_namespace</span> <span class="hl def">=</span> <span class="hl kwd">inj_get_namespace</span><span class="hl def">(.caller_env))</span>
</div></pre>
<pre><div class="source">    <span class="hl def">handler</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">getOption</span><span class="hl def">(</span><span class="hl sng">"cli.default_handler"</span><span class="hl def">, metayer_cli_handler)</span>
</div></pre>
<pre><div class="source">    <span class="hl def">withr</span><span class="hl opt">::</span><span class="hl kwd">with_environment</span><span class="hl def">(wenv,</span> <span class="hl kwd">handler</span><span class="hl def">(cnd))</span>
</div></pre>
<pre><div class="source">    <span class="hl kwd">cnd_signal</span><span class="hl def">(outer_cnd)</span>
</div></pre>
<pre><div class="source">    <span class="hl kwd">invisible</span><span class="hl def">(</span><span class="hl kwa">NULL</span><span class="hl def">)</span>
</div></pre>
<pre><div class="source">}</div></pre>
<pre><div class="source">&lt;bytecode: 0x5c7097253200&gt;</div></pre>
<pre><div class="source"></div></pre>
</div>
<!-- rnb-html-end -->
<p>Compare, for example, to the implementation of our wrapped
<code>cli_text</code> function. Note the substitution within the
conditional block that generates <code>outer_cnd</code>.
<code>cmd</code> is replaced by
<code>cli::cli_text(..., .envir = .envir)</code>.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">code</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/deparse.html" class="external-link">deparse</a></span><span class="op">(</span><span class="va">cli_text</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/display_source.html">display_source</a></span><span class="op">(</span></span>
<span>    <span class="va">code</span>,</span>
<span>    raw <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<!-- rnb-html-begin -->
<div id="div-3cae">
<style>
#div-3cae .inline, #div-3cae .source {
  background-color: #fff5ee;
}
#div-3cae .source {
  margin: 1em 0 0 0;
  padding: 1em;
}
#div-3cae .hl.num {
  color: #ff1493;
}
#div-3cae .hl.sng {
  color: #ff1493;
}
#div-3cae .hl.com {
  color: #2929cc;
}
#div-3cae .hl.opt {
  color: #676767;
}
#div-3cae .hl.def {
  color: #000000;
}
#div-3cae .hl.kwa {
  color: #2e8b57;
  font-weight: bold;
}
#div-3cae .hl.kwb {
  color: #2e8b57;
  font-weight: bold;
}
#div-3cae .hl.kwc {
  color: #696969;
  font-weight: bold;
}
#div-3cae .hl.kwd {
  color: #00008f;
}
</style>
<pre><div class="source">
<span class="hl kwa">function</span> <span class="hl def">(</span><span class="hl kwc">...</span><span class="hl def">,</span> <span class="hl kwc">.envir</span> <span class="hl def">=</span> <span class="hl kwd">parent.frame</span><span class="hl def">())</span>
<span class="hl def">{</span>
    <span class="hl def">mc</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">match.call</span><span class="hl def">()</span>
    <span class="hl def">.current_env</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">current_env</span><span class="hl def">()</span>
    <span class="hl def">.caller_env</span> <span class="hl kwb">&lt;-</span> <span class="hl def">.current_env</span><span class="hl opt">$</span><span class="hl def">.caller_env</span> <span class="hl opt">%||%</span> <span class="hl kwd">caller_env</span><span class="hl def">()</span>
    <span class="hl def">outer_cnd</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">catch_cnd</span><span class="hl def">({</span>
        <span class="hl kwa">if</span> <span class="hl def">(</span><span class="hl sng">"cmd_call"</span> <span class="hl opt">%in%</span> <span class="hl kwd">names</span><span class="hl def">(mc)) {</span>
            <span class="hl kwd">eval</span><span class="hl def">(</span><span class="hl kwd">`$`</span><span class="hl def">(.current_env, cli</span><span class="hl opt">::</span><span class="hl kwd">cli_text</span><span class="hl def">(...,</span> <span class="hl kwc">.envir</span> <span class="hl def">= .envir)),</span>
                <span class="hl kwc">envir</span> <span class="hl def">= .current_env)</span>
        <span class="hl def">}</span>
        <span class="hl kwa">else</span> <span class="hl def">{</span>
            <span class="hl def">cli</span><span class="hl opt">::</span><span class="hl kwd">cli_text</span><span class="hl def">(...,</span> <span class="hl kwc">.envir</span> <span class="hl def">= .envir)</span>
        <span class="hl def">}</span>
    <span class="hl def">})</span>
    <span class="hl kwa">if</span> <span class="hl def">(</span><span class="hl kwd">inherits</span><span class="hl def">(outer_cnd,</span> <span class="hl sng">"cli_message"</span><span class="hl def">)) {</span>
        <span class="hl def">cnd</span> <span class="hl kwb">&lt;-</span> <span class="hl def">outer_cnd</span>
    <span class="hl def">}</span>
    <span class="hl kwa">else if</span> <span class="hl def">(</span><span class="hl kwd">inherits</span><span class="hl def">(outer_cnd,</span> <span class="hl sng">"condition"</span><span class="hl def">)) {</span>
        <span class="hl def">cnd</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">catch_cnd</span><span class="hl def">(cli</span><span class="hl opt">::</span><span class="hl kwd">cli_verbatim</span><span class="hl def">(</span><span class="hl kwd">format</span><span class="hl def">(outer_cnd,</span>
            <span class="hl kwc">backtrace</span> <span class="hl def">=</span> <span class="hl num">FALSE</span><span class="hl def">)))</span>
    <span class="hl def">}</span>
    <span class="hl kwa">else</span> <span class="hl def">{</span>
        <span class="hl def">msg</span> <span class="hl kwb">&lt;-</span> <span class="hl def">glue</span><span class="hl opt">::</span><span class="hl kwd">glue</span><span class="hl def">(</span><span class="hl sng">"unexpected result: {outer_cnd}"</span><span class="hl def">,</span> <span class="hl kwc">.null</span> <span class="hl def">=</span> <span class="hl kwd">getOption</span><span class="hl def">(</span><span class="hl sng">"metayer.cli_null"</span><span class="hl def">))</span>
        <span class="hl def">cnd</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">error_cnd</span><span class="hl def">(</span><span class="hl kwc">message</span> <span class="hl def">= msg)</span>
    <span class="hl def">}</span>
    <span class="hl def">wenv</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">new_environment</span><span class="hl def">(</span><span class="hl kwc">parent</span> <span class="hl def">= .current_env)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">env_rename</span><span class="hl def">(</span><span class="hl sng">"logger_injection"</span><span class="hl def">)</span>
    <span class="hl kwd">env_bind</span><span class="hl def">(wenv,</span> <span class="hl kwc">.log_level</span> <span class="hl def">=</span> <span class="hl num">400L</span><span class="hl def">,</span> <span class="hl kwc">.log_namespace</span> <span class="hl def">=</span> <span class="hl kwd">inj_get_namespace</span><span class="hl def">(.caller_env))</span>
    <span class="hl def">handler</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">getOption</span><span class="hl def">(</span><span class="hl sng">"cli.default_handler"</span><span class="hl def">, metayer_cli_handler)</span>
    <span class="hl def">withr</span><span class="hl opt">::</span><span class="hl kwd">with_environment</span><span class="hl def">(wenv,</span> <span class="hl kwd">handler</span><span class="hl def">(cnd))</span>
    <span class="hl kwd">cnd_signal</span><span class="hl def">(outer_cnd)</span>
    <span class="hl kwd">invisible</span><span class="hl def">(</span><span class="hl kwa">NULL</span><span class="hl def">)</span>
<span class="hl def">}</span>
</div></pre>
</div>
<!-- rnb-html-end -->
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dustin Lennon.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
